<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lilyfy – Player HLS SoundCloud</title>

  <!-- HLS.js para reprodução de .m3u8 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root {
      --roxo: #8a2be2;
      --cinza: #181818;
      --cinza-claro: #b3b3b3;
      --preto: #121212;
      --branco: #ffffff;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family:'Segoe UI',sans-serif;
      background: var(--preto);
      color: var(--branco);
      display:flex; flex-direction:column;
      min-height:100vh;
    }
    .container {
      flex:1; max-width:800px; width:100%;
      margin: auto; padding:20px;
    }
    header { text-align:center; margin-bottom:20px; }
    h1 { color: var(--roxo); }
    .search-box {
      display:flex; gap:10px; margin-bottom:20px;
    }
    .search-box input {
      flex:1; padding:10px 14px; border-radius:6px;
      border:1px solid #444; background:#222; color:#fff;
      font-size:16px;
    }
    .search-box button {
      background: var(--roxo); border:none;
      padding: 0 20px; font-size:16px; font-weight:bold;
      border-radius:6px; cursor:pointer; color:#fff;
    }
    #playerContainer {
      display:none; margin-top:20px;
    }
    video, audio {
      width:100%; border-radius:8px;
      background:#000;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Lilyfy HLS SoundCloud</h1>
      <p>Cole a URL de uma faixa do SoundCloud e toque completa</p>
    </header>

    <div class="search-box">
      <input type="text" id="trackUrlInput"
             placeholder="https://soundcloud.com/usuário/faixa">
      <button onclick="startPlayback()">Tocar</button>
    </div>

    <div id="messages"></div>

    <div id="playerContainer">
      <!-- O HLS.js vai injetar o <video> aqui -->
    </div>
  </div>

  <script>
    const rapidKey = "be6d832346msh3bdcbc41a36e31fp1de253jsnfd355f97011f";
    const host3   = "soundcloud-api3.p.rapidapi.com";

    async function startPlayback() {
      const trackUrl = document.getElementById("trackUrlInput").value.trim();
      const msg = document.getElementById("messages");
      const playerDiv = document.getElementById("playerContainer");
      msg.textContent = "";
      playerDiv.innerHTML = "";
      playerDiv.style.display = "none";

      if (!trackUrl) {
        msg.textContent = "Por favor, cole a URL de uma faixa do SoundCloud.";
        return;
      }

      try {
        msg.textContent = "1/3 → Resolvendo trackId…";
        // 1) Resolve a URL para obter o trackId
        const resResolve = await fetch(
          `https://${host3}/v1/resolve?url=${encodeURIComponent(trackUrl)}`,
          {
            method: "GET",
            headers: {
              "X-Rapidapi-Key": rapidKey,
              "X-Rapidapi-Host": host3
            }
          }
        );
        const jsonResolve = await resResolve.json();
        const trackId = jsonResolve.id;
        if (!trackId) throw new Error("Não conseguiu resolver trackId.");

        msg.textContent = "2/3 → Buscando dados do track…";
        // 2) Buscar metadados do track (inclui streamId e authorization)
        const resMeta = await fetch(
          `https://${host3}/v1/tracks/${trackId}`,
          {
            method: "GET",
            headers: {
              "X-Rapidapi-Key": rapidKey,
              "X-Rapidapi-Host": host3
            }
          }
        );
        const meta = await resMeta.json();
        const streamId           = meta.streamId;
        const trackAuthorization = meta.trackAuthorization;
        if (!streamId || !trackAuthorization) {
          throw new Error("Dados de streaming não disponíveis.");
        }

        msg.textContent = "3/3 → Carregando stream HLS e tocando…";
        // 3) Obter URL HLS
        const resStream = await fetch(
          `https://${host3}/getStreamUrl?streamId=${encodeURIComponent(streamId)}&trackAuthorization=${encodeURIComponent(trackAuthorization)}`,
          {
            method: "GET",
            headers: {
              "X-Rapidapi-Key": rapidKey,
              "X-Rapidapi-Host": host3
            }
          }
        );
        const sjson = await resStream.json();
        const hlsUrl = sjson.url;
        if (!hlsUrl) throw new Error("Não obteve URL de streaming.");

        // 4) Reproduzir com HLS.js
        playerDiv.style.display = "block";
        msg.textContent = "";

        const video = document.createElement("video");
        video.controls = true;
        playerDiv.appendChild(video);

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(hlsUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = hlsUrl;
          video.addEventListener("loadedmetadata", () => video.play());
        } else {
          throw new Error("HLS não suportado pelo navegador.");
        }

      } catch (err) {
        console.error(err);
        msg.textContent = "❌ " + err.message;
      }
    }
  </script>
</body>
</html>
